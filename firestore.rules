rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.role == 'admin' ||
        request.auth.token.admin == true ||
        request.auth.token.email == 'zettler.jj@ilytat.com'
      );
    }

    function isTenantMember(tenantId) {
      // Allow if token has specific tenantId claim OR if user is global admin or specific email
      return isAuthenticated() && (
        request.auth.token.tenantId == tenantId || 
        request.auth.token.role == 'admin' ||
        request.auth.token.admin == true ||
        request.auth.token.email == 'jj@ilytat.com' || // Kept for safety
        request.auth.token.email == 'admin@ilytat.com' || // Kept for safety
        request.auth.token.email == 'zettler.jj@ilytat.com'
      );
    }

    // --- Multi-Tenant Structure ---

    // Company Data
    match /companies/{tenantId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isTenantMember(tenantId); // Refine this later for granular perms

      match /tasks/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /notes/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /briefings/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /transactions/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /okrs/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /assets/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /subscriptions/{document=**} { allow read, write: if isTenantMember(tenantId); }
      match /projects/{document=**} { allow read, write: if isTenantMember(tenantId); }
    }

    // Personal Data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Allow access to all subcollections
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- Shared / Public / Root Collections (Legacy or System) ---

    // Metadata Collection (System Config)
    // Authenticated read access allowed for global system settings
    match /metadata/{documentId} {
      allow read: if isAuthenticated();
      allow write: if false; // Internal/Admin only
    }

    // Quotes - Keep public read for now
    match /quotes/{quoteId} {
      allow read: if true;
      allow write: if isAuthenticated(); // Restrict?
    }

    // Root Collections (Legacy Support - Optional)
    // You might want to remove these after full migration
    match /tasks/{taskId} {
      allow read: if isOwner(resource.data.userId); // Read only if existing resource is mine
      allow create: if isOwner(request.resource.data.userId); // Create only if I set myself as owner
      allow update, delete: if isOwner(resource.data.userId); // Update only if existing resource is mine
    }
    match /dates/{dateId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);
    }
    // ... other legacy roots can be matched generic or removed
    
  }
}
